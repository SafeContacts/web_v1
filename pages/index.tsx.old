/*** File: pages/index.tsx */

/***
import { useEffect, useState } from 'react';
import Layout from '../components/Layout';
import ContactCard from '../components/ContactCard';
import SuggestedUpdatesPanel from '../components/SuggestedUpdatesPanel';
import CallLog from '../components/CallLog';
import AddContactForm from '../components/AddContactForm';

/**
 * Decode the user ID from the JWT in localStorage.
 * If no token is present, fall back to a demo user ID so the page still works.

function getCurrentUserId(): string {
  try {
    const token = localStorage.getItem('token');
    if (!token) return 'demo-user';
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.sub || 'demo-user';
  } catch {
    return 'demo-user';
  }
}

export default function HomePage() {
  const [userId, setUserId] = useState<string>('demo-user');
  const [contacts, setContacts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Decode the user ID when the component mounts.
    const uid = getCurrentUserId();
    setUserId(uid);

    async function fetchContacts() {
      try {
        setLoading(true);
        const res = await fetch(`/api/contacts?userId=${uid}`);
        if (res.ok) {
          const data = await res.json();
          setContacts(data);
        } else {
          console.error('Failed to fetch contacts', await res.json());
        }
      } catch (err) {
        console.error(err);
      } finally {
        setLoading(false);
      }
    }
    fetchContacts();
  }, []);

  return (
    <div>
      <h1>My Contacts</h1>
      {/* Show pending update suggestions for this user /}
      <SuggestedUpdatesPanel userId={userId} />
      {/* Form to add a new contact. On success, append to local state /}
      <AddContactForm
        userId={userId}
        onCreated={(contact) => setContacts((prev) => [...prev, contact])}
      />
      {loading ? (
        <p>Loading contactsâ€¦</p>
      ) : contacts.length === 0 ? (
        <p>No contacts found. Sync your device or add a contact above.</p>
      ) : (
        contacts.map((c) => (
          <ContactCard key={c._id} contact={c} userId={userId} />
        ))
      )}
      {/* Show recent call logs for this user /}
      <CallLog userId={userId} />
      </div>
  );
}

 */

import { useEffect, useState } from 'react';
import Head from "next/head";
import ContactCard from "../components/ContactCard";

interface Contact {
  _id: string;
  name: string;
  phones: Array<{ value: string }> | string[];
  emails: Array<{ value: string }> | string[];
  company?: string;
  trustScore?: number;
  tags?: string[];
  updatedAt?: string;
}

export default function HomePage() {
  const [contacts, setContacts] = useState<Contact[]>([]);
  const [query, setQuery] = useState("");
  useEffect(() => {
    async function fetchContacts() {
      try {
        const resp = await fetch("/api/contacts");
        if (resp.ok) {
          const data = await resp.json();
          setContacts(data);
        }
      } catch (err) {
        console.error(err);
      }
    }
    fetchContacts();
  }, []);
  const filtered = contacts.filter((c) => {
    if (!query) return true;
    const q = query.toLowerCase();
    return (
      c.name?.toLowerCase().includes(q) ||
      (Array.isArray(c.phones) && c.phones.some((p: any) => p.value?.includes(q) || p.includes?.(q))) ||
      (Array.isArray(c.emails) && c.emails.some((e: any) => e.value?.toLowerCase().includes(q) || e.toLowerCase?.().includes(q)))
    );
  });
  const total = contacts.length;
  const verified = contacts.filter((c) => (c.trustScore ?? 0) >= 80).length;
  const pendingSync = 0;
  const networkUpdates = 0;
  return (
    <div className="min-h-screen bg-gray-50 py-6">
      <Head>
        <title>SafeContacts</title>
      </Head>
      <header className="max-w-6xl mx-auto px-4 mb-6">
        <h1 className="text-3xl font-bold mb-4 flex items-center space-x-2">
          <span>SafeContacts</span>
        </h1>
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
          <div className="bg-white rounded-lg p-4 shadow">
            <div className="text-sm text-gray-500">Total Contacts</div>
            <div className="text-2xl font-semibold">{total}</div>
          </div>
          <div className="bg-white rounded-lg p-4 shadow">
            <div className="text-sm text-gray-500">Verified</div>
            <div className="text-2xl font-semibold">{verified}</div>
          </div>
          <div className="bg-white rounded-lg p-4 shadow">
            <div className="text-sm text-gray-500">Pending Sync</div>
            <div className="text-2xl font-semibold">{pendingSync}</div>
          </div>
          <div className="bg-white rounded-lg p-4 shadow">
            <div className="text-sm text-gray-500">Network Updates</div>
            <div className="text-2xl font-semibold">{networkUpdates}</div>
          </div>
        </div>
        <h2 className="text-2xl font-semibold mb-2">Contact Directory</h2>
        <p className="text-sm text-gray-600 mb-4">Search and manage your contacts</p>
        <div className="flex items-center space-x-2 mb-4">
          <input
            type="text"
            className="w-full md:w-1/2 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
            placeholder="Search contacts..."
            value={query}
            onChange={(e) => setQuery(e.target.value)}
          />
          <button
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            disabled
          >
            Filter
          </button>
        </div>
      </header>
      <main className="max-w-6xl mx-auto px-4">
        <div className="space-y-2">
          {filtered.map((contact) => (
            <ContactCard key={contact._id} contact={contact} />
          ))}
          {filtered.length === 0 && (
            <div className="text-gray-500">No contacts found.</div>
          )}
        </div>
      </main>
    </div>
  );
}
